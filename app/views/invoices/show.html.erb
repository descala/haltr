<!--menu rapid-->
<div class="seccio grup">
  <div class="col span-2-de-2">
    <ul class="menu-rapid">
      <% if @invoice.order -%>
        <li><%= link_to_if_authorized l(:label_order), project_order_path(@invoice.order, project_id: @project), class: 'icon' %></li>
      <% end -%>
      <% if @invoice.is_a? InvoiceTemplate %>
        <li><%= link_to_if_authorized l("label_invoice_template_new"), new_project_invoice_template_path(@project), class: 'icon icon-add' %></li>
      <% elsif @invoice.is_a? IssuedInvoice %>
        <li><%= link_to_if_authorized l("label_invoice_new"), new_project_invoice_path(@project), class: 'icon icon-add' %></li>
      <% end %>
      <% if @invoice.is_a?(ReceivedInvoice) and @invoice.invoice_format == 'pdf' -%>
        <li><%= link_to_if_authorized l(:button_edit_metadata), { action: 'edit', id: @invoice }, class: 'icon icon-edit' %></li>
      <% elsif !@invoice.is_a?(ReceivedInvoice) -%>
        <li><%= link_to_if_authorized l(:button_edit), { action: 'edit', id: @invoice }, class: 'icon icon-edit' %></li>
      <% end -%>
      <li><%= link_to_if_authorized l(:button_delete), { action: 'destroy', id: @invoice}, data: {confirm: l(:text_are_you_sure)}, method: :delete, class: 'icon icon-del' %></li>
      <%= render partial: "#{@invoice.class.to_s.underscore}_menu" %>
      <% if @invoice.next%>
        <li class="invoice-navigator"><%=h link_to_if_authorized l(:label_next), action: 'show', id: @invoice.next %></li>
      <% end %>
      <% if @invoice.previous %>
        <li class="invoice-navigator"><%=h link_to_if_authorized l(:label_previous), action: 'show', id: @invoice.previous %></li>
      <% end %>
    </ul>
  </div>
</div>
<!--final menu rapid-->

<% if @invoice.is_a? ReceivedInvoice -%>
  <div id="invoice-refuse" class="accept_refuse_form" style="display: none;">
    <%= render partial: "invoice_refuse_form" %>
  </div>
  <div id="invoice-accept" class="accept_refuse_form" style="display: none;">
    <%= render partial: "invoice_accept_form" %>
  </div>
<% end -%>

<% if @invoice_pdf -%>
  <div id="invoice_img">
    <div class="colu1">
      <iframe src="/pdfjs/web/viewer.html?file=<%=@invoice_pdf%>" style="border: 0" width="720px" height="890" frameborder="0" scrolling="no"></iframe>
    </div>
    <div class="colu2">
      <% if @invoice.state == 'processing_pdf' -%>
        <p><%= I18n.t @invoice.state %></p>
      <% elsif @invoice.invoice_img -%>
        <%= render partial: 'invoice_imgs/metadata', locals: {invoice_img: @invoice.invoice_img } %>
      <% else -%>
        <%= labelled_form_for :invoice, @invoice, url: invoice_path(@invoice) do |f| %>
          <fieldset class="tabular box">
          <div class="seccio grup">
            <p class="col pdf" id="client_select">
            <% if @invoice.is_a? ReceivedInvoice -%>
              <%= render partial: 'received/clients', locals: {selected: @created_client || @invoice.client_id} %>
            <% else -%>
              <%= render partial: 'invoices/clients', locals: {selected: @created_client || @invoice.client_id} %>
            <% end -%>
            </p>
          </div>
          <%= f.submit l(:button_update), name: 'create' %>
          </fieldset>
        <% end -%>
        <div id="new_client_wrapper" style="display:none;">
          <%= render partial: 'invoices/new_client', locals: {context: "edit_invoice"} %>
        </div>

        <div>
          <p><%= t :credit %>: <%= @project.company.free_ocr_account.balance.to_f + @project.company.free_issues_account.balance.to_f + @project.company.buy_account.balance.to_f %>â‚¬</p>
          <p><%= link_to button_tag(I18n.t(:process_pdf), class: ''), process_pdf_path(@invoice), method: :post %></p>
        </div>

      <% end -%>
    </div>
  </div>
<% else -%>

  <% if @invoice.invoice_img -%>
    <%= render partial: 'invoice_imgs/show', locals: {invoice_img: @invoice.invoice_img } %>
  <% else -%>

    <div id="invoice_wrapper">
      <div class="ribbon ribbon-<%= @invoice.state %>">
        <% if @invoice.is_a? InvoiceTemplate %>
          <span><%=h l("label_invoice_template") %></span>
        <% else %>
          <span title="<%= format_time @invoice.state_updated_at %>"><%=h l("state_#{@invoice.state}").capitalize %></span>
        <% end %>
      </div>
      <div id="workspace1" class="haltrinvoice">
        <div id="workspace2">
          <div id="col1">
            <%= render partial: 'invoices/invoice' %>
            <%= link_to_attachments @invoice, thumbnails: false, author: false %>
          </div>
        </div>
      </div>
    </div>

  <% end -%>

<% end -%>

  <% if @invoice.send_original? and @invoice.is_a? IssuedInvoice %>
    <% if @invoice.original and @invoice.invoice_format == 'pdf' -%>
      <p>* <%= @invoice.invoice_format.upcase rescue "" %> <%= l(:label_will_send_original_pdf) -%></p>
    <% else -%>
      <p>* <%= @invoice.invoice_format.upcase rescue "" %> <%= l(:label_will_send_original) -%></p>
    <% end -%>
  <% end -%>

  <div class="seccio grup">
    <div class="col span-2-de-2">
      <div class="invoice-comments">
        <h3 id="haltr_comments">
          <%=h l(:label_comment_plural)%>
          <%= toggle_link image_tag('add.png'), "add_comment_form", focus: "comment_comments" %>
        </h3>
        <%= form_tag({controller: 'invoices', action: 'add_comment', id: @invoice, project_id: @project}, id: "add_comment_form", style: "display:none;") do %>
          <div class="box">
            <%= text_area 'comment', 'comments', cols: 80, rows: 5, class: 'wiki-edit' %>
          </div>
          <p><%= submit_tag l(:button_add) %></p>
        <% end %>

        <ul>
          <% @invoice.comments.reverse.each do |comment| -%>
            <li><strong><%= format_time comment.created_on %></strong> - <%= comment.author.name %>: <%= comment.comments %></li>
          <% end -%>
        </ul>
      </div>
    </div>
  </div>

<%= render partial: 'events/list', locals: {events: @invoice.visible_events} %>
<%= render partial: 'invoices/issued_invoice_list_other' if @invoice.is_a? IssuedInvoice %>
<%= render partial: 'invoices/channel_links' if (Rails.env == "development" or User.current.allowed_to?(:use_all_readonly, @project)) and @invoice.is_a? IssuedInvoice %>

<% if @invoice.is_a? InvoiceTemplate and @invoices_generated and @invoices_generated.any? -%>
  <h3><%= l(:label_generated_invoices)%></h3>
  <p>
  <% @invoices_generated.each do |invoice| -%>
    <%=link_to_if_authorized invoice.number, controller: 'invoices', action: 'show', id: invoice %><%= ", " unless invoice == @invoices_generated.last %>
  <% end -%>
  </p>
<% end -%>

<% content_for :sidebar do %>
  <%= render_menu :invoices_menu, @project %>
<% end %>
<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'minimal', plugin: 'haltr' %>
<% end %>

<%=
  # @autocall will be automatically called from javascript (haltr_sign.js)
# we can get here when pressing "save and send" button on invoice form if
# invoice is sent with javascript method (javascript attribute on channels.yml)
tag("div", id: 'autocall', 'data-function' => @autocall, 'data-args' => @autocall_args) if @autocall
%>

<%=
  if @invoice.client and @invoice.client.sign_with_local_certificate?
    content_for :header_tags do
      javascript_include_tag('/invoices/haltr_sign.js') +
        javascript_include_tag('miniapplet.js', plugin: 'haltr')
    end
  end

  if (@invoice.is_a? IssuedInvoice and @invoice.sending?) or
    (@invoice.is_a? ReceivedInvoice and @invoice.processing_pdf?)
    content_for :header_tags do
      javascript_include_tag 'refresher.js', plugin: 'haltr'
    end
  end
%>
