<%= render partial: 'invoice_header' %>

<!-- Invoice Data -->
<div class="invoice">

  <!-- Line Details -->
  <table class="line-items splitForPrint" border="0" cellpadding="0" cellspacing="0">
    <thead>
      <tr>
        <% line_cells = 4 -%>
        <% if @invoice.has_delivery_note_numbers? -%>
          <% line_cells += 1 -%>
          <th class="item-delivery_note first"><%=h l(:field_delivery_note_number) %></th>
        <% end -%>
        <th class="item-quantity"><abbr title="Quantitat">Q</abbr></th>
        <% if @invoice.has_article_codes? -%>
          <% line_cells += 1 -%>
          <th class="item-article_code"><%=h l(:field_article_code)%></th>
        <% end -%>
        <th class="item-description"><%=h l(:field_description)%></th>
        <% if @lines.any? {|l| !l.sequence_number.blank? } -%>
          <% line_cells += 1 -%>
          <th class="item-sequence-number"><%= l(:sequence_number) %></th>
        <% end -%>
        <th class="item-price"><%=h l(:field_amount) %></th>
        <% if @invoice.has_line_discounts? -%>
          <% line_cells += 1 -%>
          <th class="item-price"><%=h l(:field_discount) %></th>
        <% end -%>
        <% if @invoice.has_line_charges? -%>
          <% line_cells += 1 -%>
          <th class="item-price"><%= h l(:field_charge) %></th>
        <% end -%>
        <th class="line-total last"><%=h l(:label_invoice_total)%></th>
      </tr>
    </thead>

    <tbody>
      <% @lines.each do |line| -%>
        <tr <%= 'class="nobottomline"'.html_safe unless line.notes.blank? %>>
          <% if @invoice.has_delivery_note_numbers? -%>
            <td class="item-delivery_note first"><%=h line.delivery_note_number %></td>
          <% end -%>
          <td class="item-quantity"><%=h quantity(line.quantity) %> <%=h line.unit_short%></td>
          <% if @invoice.has_article_codes? -%>
            <td class="item-article_code"><%=h line.article_code %></td>
          <% end -%>
          <td class="item-description">
            <%=h line.description %>
            <% if line.charge_reason.present? -%>
              <br /><%= l(:field_charge) %>: <%= line.charge_reason %>
            <% end -%>
            <% if line.discount_text.present? and line.discount_text != '.' -%>
              <br /><%= l(:field_discount) %>: <%= line.discount_text %>
            <% end -%>
          </td>
          <% if @lines.any? {|l| !l.sequence_number.blank? } -%>
            <td><%= line.sequence_number %></td>
          <% end -%>
          <td class="item-price"><%=h line_price(line, 'price', @invoice) %></td>
          <% if line.discount_percent > 0 -%>
            <td class="item-price"><%=h number_to_percentage(line.discount_percent, precision: 2, strip_insignificant_zeros: true) %></td>
          <% elsif @invoice.has_line_discounts? -%>
            <td></td>
          <% end -%>
          <% if @invoice.has_line_charges? -%>
            <td class="item-price"><%= h line_price(line, 'charge', @invoice) %></td>
          <% end -%>
          <td class="line-total last"><%=h money(line.taxable_base.to_money(@invoice.currency)) %></td>
        </tr>
        <% unless line.notes.blank? -%>
          <tr>
            <td></td>
            <td colspan="<%= line_cells - 1 %>"><%= l(:field_extra_info) %>: <%= line.notes %></td>
          </tr>
        <% end -%>
      <% end -%>

      <% if @invoice.discount_percent and @invoice.discount_percent > 0 -%>
        <tr>
          <td class="item-quantity first"></td>
          <% if @invoice.has_article_codes? -%>
            <td class="item-article_code"></td>
          <% end -%>
          <td class="item-description" <%= 'colspan="2"'.html_safe if @invoice.has_line_discounts? %>><%=h @invoice.discount_text %></td>
          <td class="item-price"><%=h number_to_percentage(@invoice.discount_percent, precision: 2, strip_insignificant_zeros: true) %></td>
          <% if @invoice.has_line_charges? -%>
            <td></td>
          <% end -%>
          <td class="line-total last">- <%=h money(@invoice.discount_amount) %></td>
        </tr>
      <% end -%>

      <% if @invoice.charge_amount.cents > 0 -%>
        <tr>
          <td class="item-quantity first"></td>
          <% if @invoice.has_article_codes? -%>
            <td class="item-article_code"></td>
          <% end -%>
          <td class="item-description" <%= colspan_for(@invoice) %>><%=h @invoice.charge_reason %></td>
          <td class="item-price"></td>
          <td class="line-total last"><%=h money(@invoice.charge_amount) %></td>
        </tr>
      <% end -%>


  </tbody></table>

  <!-- Totals Details -->
  <table class="invoice-calculations" border="0" cellpadding="0" cellspacing="0">
    <tbody><tr class="invoice-subtotal">
        <th><%=h l(:label_subtotal)%>:</th>
        <td><%=h money(@invoice.subtotal) %></td>
      </tr>
      <% @invoice.taxes_uniq.each do |tax| -%>
      <tr class="sales-tax">
        <th><%= h tax_name(tax) %> <%= " #{l(:over_taxable_base)} #{money(@invoice.taxable_base(tax))}" unless @invoice.tax_applies_to_all_lines?(tax) %>:</th>
        <td><%= h money(@invoice.tax_amount(tax)) %></td>
      </tr>
      <% end -%>
      <tr class="invoice-total">
        <th><%=h l(:label_invoice_total)%>:</th>
        <td><%=h money(@invoice.total) %></td>
      </tr>
      <% if @invoice.payments_on_account_in_cents.to_i > 0 -%>
        <tr>
          <th><%=h l(:field_payments_on_account) %></th>
          <td><%=h money(@invoice.payments_on_account) %></td>
        </tr>
        <tr class="invoice-total">
          <th><%=h l(:total_executable) %></th>
          <td><%=h money(@invoice.total - @invoice.payments_on_account) %></td>
        </tr>
      <% end -%>
  </tbody></table>

  <% if @invoice.is_a?(IssuedInvoice) and @invoice.payments.any? -%>

    <!-- Payment Details -->
    <table class="line-items payments" border="0" cellpadding="0" cellspacing="0">
      <tbody>
        <tr>
          <th class="item-delete first"></th>
          <th class="item-date"><%=h l :field_due_date %></th>
          <th class="item-description"><%=h l :field_description%></th>
          <th class="line-total last"><%=h l :field_quantity %></th>
        </tr>
        <% @invoice.payments.each do |payment| -%>
          <tr>
            <td class="item-delete first"><%= link_to_if_authorized "", {:action=>'destroy_payment',:id=>payment} , :confirm => l(:text_are_you_sure), :method => :delete, :class => 'icon icon-del' %></td>
            <td class="item-date first"><%=h format_date payment.date %></td>
            <td class="item-description"><%=h payment.description %></td>
            <td class="line-total last"><%=h money(payment.amount) %></td>
          </tr>
        <% end -%>
      </tbody>
    </table>

    <!-- Payment Total Details -->
    <table class="invoice-calculations payments" border="0" cellpadding="0" cellspacing="0">
      <tbody>
        <tr class="invoice-total">
          <th><%=h l :field_total_paid %>:</th>
          <td><%=h money(@invoice.total_paid) %></td>
        </tr>
    </tbody></table>

  <% end -%>

</div>

<div class="notes">
<% if !@invoice.extra_info.blank? or
     @invoice.taxes.collect {|t| t if t.exempt? and !t.comment.blank? }.compact.any? -%>
    <h3><%=h l(:field_extra_info)%></h3>
    <% unless @invoice.extra_info.blank? -%>
      <span class="invoice-terms"><%= simple_format(h @invoice.extra_info) %></span>
    <% end -%>
    <% @invoice.taxes_uniq.each do |t| -%>
      <% next unless t.exempt? and !t.comment.blank? -%>
      <span class="invoice-terms"><%= simple_format(h "#{tax_name(t)}: #{t.comment}") %></span>
    <% end -%><br/>
<% end -%>
</div>

<% unless @invoice.company.company_identifier.blank? %>
  <p class="companyid"><%= l(:field_company_identifier) %>: <%=@invoice.company.company_identifier%></p>
<% end -%>
